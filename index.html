<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nobel winners — year & category</title>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --border:#e6e6e6; --card:#fafafa; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); }
    .wrap { max-width:1100px; margin:0 auto; padding:28px 16px 44px; }
    h1 { margin:0 0 6px 0; font-size:22px; font-weight:700; }
    .sub { margin:0 0 18px 0; color:var(--muted); font-size:13px; line-height:1.45; }

    .panel {
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
      padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--card);
      margin-bottom:14px;
    }
    .field label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input[type="range"] { width:100%; }
    select { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:white; font-size:13px; }
    .rangeRow { display:flex; align-items:center; gap:10px; }
    .pill { font-size:12px; border:1px solid var(--border); background:white; padding:6px 10px; border-radius:999px; min-width:72px; text-align:center; }

    .sectionTitle { margin:18px 0 10px 0; font-size:14px; font-weight:700; }

    .cards { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card { border:1px solid var(--border); border-radius:12px; padding:12px; background:white; }
    .kicker { font-size:12px; color:var(--muted); margin-bottom:6px; }
    .name { font-weight:700; font-size:14px; margin-bottom:6px; }
    .mot { font-size:12.5px; line-height:1.4; color:#222; }

    #chartBox { margin-top:12px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:white; }
    #status { margin-top:10px; font-size:12px; color:var(--muted); }

    @media (max-width: 900px) { .cards { grid-template-columns: 1fr; } }
    @media (max-width: 620px) { .panel { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Nobel winners</h1>
    <p class="sub">
      Seleziona <b>anno</b> e <b>categoria</b>: mostro i winners (nome + motivazione) e la composizione del team (female/male).
    </p>

    <div class="panel">
      <div class="field">
        <label for="yearSlider">Year</label>
        <div class="rangeRow">
          <input id="yearSlider" type="range" />
          <span class="pill" id="yearVal"></span>
        </div>
      </div>

      <div class="field">
        <label for="categoryToggle">Category</label>
        <select id="categoryToggle"></select>
      </div>
    </div>

    <div class="sectionTitle" id="title">Winners</div>
    <div id="winners"></div>

    <div class="sectionTitle">Team composition</div>
    <div id="chartBox"><div id="chart"></div></div>

    <div id="status"></div>
  </div>

<script>
  const TIDY_CSV_URL = "data/nobel_affiliations_tidy.csv";
  const META_JSON_URL = "data/nobel_filters_meta.json";

  let DATA = [];
  let META = null;

  const els = {
    yearSlider: document.getElementById("yearSlider"),
    yearVal: document.getElementById("yearVal"),
    categoryToggle: document.getElementById("categoryToggle"),
    title: document.getElementById("title"),
    winners: document.getElementById("winners"),
    status: document.getElementById("status"),
  };

  function setOptions(selectEl, values) {
    selectEl.innerHTML = "";
    values.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
  }

  function getYear() { return Number(els.yearSlider.value); }
  function getCategory() { return els.categoryToggle.value; }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // Dedup: multiple affiliations per laureate -> 1 record per laureate/year/category/motivation
  function dedupLaureates(rows) {
    const seen = new Set();
    const out = [];
    for (const r of rows) {
      const key = [r.laureate_id, r.award_year, r.category, r.motivation_en].join("||");
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(r);
    }
    return out;
  }

  function getWinners(year, category) {
    const subset = DATA.filter(r => r.award_year === year && r.category === category);
    return dedupLaureates(subset);
  }

  function computeStats(winners) {
    const female = winners.filter(x => x.gender === "female").length;
    const male = winners.filter(x => x.gender === "male").length;
    const unknown = winners.length - female - male;
    const teamSize = winners.length;
    return { female, male, unknown, teamSize };
  }

  function formatAffiliation(r) {
    const name = (r.affiliation_name ?? "").trim();
    const country = (r.affiliation_country ?? "").trim();

    if (name && country) return `${name} — ${country}`;
    if (name) return name;
    if (country) return country;
    return "Affiliation: unknown";
  }

  function renderWinnersList(winners) {
    if (winners.length === 0) {
      els.winners.innerHTML = `<div class="card">No winners found for this selection.</div>`;
      return;
    }

    els.winners.innerHTML = `
      <div class="cards">
        ${winners.map(r => `
          <div class="card">
            <div class="kicker">${escapeHtml(formatAffiliation(r))}</div>
            <div class="name">${escapeHtml(r.laureate_name)}</div>
            <div class="mot">${escapeHtml(r.motivation_en)}</div>
          </div>
        `).join("")}
      </div>
    `;
  }

  // Stacked bar: un'unica barra "Team" segmentata Female/Male (+ eventualmente Unknown)
  function renderCompositionChart(year, category, stats) {
    const x = ["Team"];

    const traceFemale = {
      type: "bar",
      x,
      y: [stats.female],
      name: "Female",
      marker: { color: "#fbb4ae" },
      hovertemplate: "<b>Female</b><br>Count: %{y}<extra></extra>",
    };

    const traceMale = {
      type: "bar",
      x,
      y: [stats.male],
      name: "Male",
      marker: { color: "#b3cde3" },
      hovertemplate: "<b>Male</b><br>Count: %{y}<extra></extra>",
    };

    const traces = [traceFemale, traceMale];

    if (stats.unknown > 0) {
      traces.push({
        type: "bar",
        x,
        y: [stats.unknown],
        name: "Unknown",
        marker: { color: "#bdbdbd" },
        hovertemplate: "<b>Unknown</b><br>Count: %{y}<extra></extra>",
      });
    }

    const layout = {
      title: { text: `Composition — ${category} (${year})`, x: 0.02, xanchor: "left", font: { size: 14 } },
      barmode: "stack",
      margin: { l: 60, r: 20, t: 60, b: 55 },
      yaxis: {
        title: "",
        rangemode: "tozero",
        tickmode: "linear",
        tick0: 0,
        dtick: 1,
        gridcolor: "#f0f0f0",
        zerolinecolor: "#e6e6e6",
      },
      xaxis: { title: "" },
      paper_bgcolor: "#ffffff",
      plot_bgcolor: "#ffffff",
      height: 420,
      legend: { orientation: "h", x: 0.02, y: -0.15 }
    };

    Plotly.react("chart", traces, layout, { displayModeBar: false, responsive: true });
  }

  function update() {
    const year = getYear();
    const category = getCategory();
    els.yearVal.textContent = year;

    els.title.textContent = `Winners — ${category} (${year})`;

    const winners = getWinners(year, category);
    const stats = computeStats(winners);

    renderWinnersList(winners);
    renderCompositionChart(year, category, stats);

    // opzionale: riassunto sotto (se non lo vuoi, lascia stringa vuota)
    els.status.textContent = "";
  }

  async function loadMeta() {
    const res = await fetch(META_JSON_URL);
    if (!res.ok) throw new Error(`Cannot load ${META_JSON_URL} (${res.status})`);
    return await res.json();
  }

  async function loadTidyCsv() {
    return new Promise((resolve, reject) => {
      Papa.parse(TIDY_CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => resolve(results.data),
        error: (err) => reject(err),
      });
    });
  }

  async function init() {
    try {
      META = await loadMeta();

      // Year slider
      const yMin = META.year_min ?? 1901;
      const yMax = META.year_max ?? 2025;
      els.yearSlider.min = String(yMin);
      els.yearSlider.max = String(yMax);
      els.yearSlider.step = "1";
      els.yearSlider.value = String(yMax);
      els.yearVal.textContent = String(yMax);

      // Category toggle
      const cats = META.categories ?? [];
      setOptions(els.categoryToggle, cats);
      if (cats.length) els.categoryToggle.value = cats[0];

      // Data
      const raw = await loadTidyCsv();
      DATA = raw.map(r => ({
        laureate_id: Number(r.laureate_id),
        laureate_name: (r.laureate_name ?? "").toString(),
        gender: (r.gender ?? "unknown").toString(),
        award_year: Number(r.award_year),
        category: (r.category ?? "unknown").toString(),
        motivation_en: (r.motivation_en ?? "").toString(),
        affiliation_name: (r.affiliation_name ?? "").toString(),
        affiliation_country: (r.affiliation_country ?? "").toString(),
      })).filter(r => Number.isFinite(r.award_year) && r.laureate_name);

      els.yearSlider.addEventListener("input", update);
      els.categoryToggle.addEventListener("change", update);

      update();
    } catch (e) {
      console.error(e);
      els.status.textContent = `Error: ${e.message}`;
    }
  }

  init();
</script>
</body>
</html>
