<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nobel distribution — Top countries</title>

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --border:#e6e6e6; --card:#fafafa; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); }
    .wrap { max-width:1100px; margin:0 auto; padding:28px 16px 40px; }
    h1 { margin:0 0 6px 0; font-size:22px; font-weight:700; }
    .sub { margin:0 0 18px 0; color:var(--muted); font-size:13px; line-height:1.4; }

    .panel {
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;
      padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--card);
      margin-bottom:14px;
    }
    .field label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input[type="range"] { width:100%; }
    select { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:white; font-size:13px; }
    .rangeRow { display:flex; align-items:center; gap:10px; }
    .pill { font-size:12px; border:1px solid var(--border); background:white; padding:6px 10px; border-radius:999px; min-width:64px; text-align:center; }

    #chart { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .foot { margin-top:10px; font-size:12px; color:var(--muted); }

    @media (max-width: 900px) { .panel { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Nobel distribution</h1>
    <p class="sub">
      Bar chart orizzontale — <b>Countries by Nobel count</b> per anno.
      Puoi sommare <b>tutte le categorie</b> oppure selezionarne una, e filtrare per gender e affiliation.
    </p>

    <div class="panel">
      <div class="field">
        <label for="categorySel">Category</label>
        <select id="categorySel"></select>
      </div>

      <div class="field">
        <label for="genderSel">Gender</label>
        <select id="genderSel"></select>
      </div>

      <div class="field">
        <label for="affSel">Affiliation</label>
        <select id="affSel"></select>
      </div>

      <div class="field" style="grid-column: 1 / -1;">
        <label for="yearSlider">Year</label>
        <div class="rangeRow">
          <input id="yearSlider" type="range" />
          <span class="pill" id="yearVal"></span>
        </div>
      </div>
    </div>

    <div id="chart"></div>
    <div class="foot" id="status">Loading…</div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const AGG_CSV_URL = "data/nobel_country_agg.csv";
  const META_JSON_URL = "data/nobel_filters_meta.json";

  const AFF_UI = [
    { value: "All", label: "All" },
    { value: "university", label: "University" },
    { value: "research_institute", label: "Research institute" },
    { value: "organization", label: "Organization" }, // company + government + other
  ];

  let DATA = [];
  let META = null;

  const els = {
    categorySel: document.getElementById("categorySel"),
    genderSel: document.getElementById("genderSel"),
    affSel: document.getElementById("affSel"),
    yearSlider: document.getElementById("yearSlider"),
    yearVal: document.getElementById("yearVal"),
    status: document.getElementById("status"),
  };

  function setOptions(selectEl, options) {
    selectEl.innerHTML = "";
    options.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      selectEl.appendChild(o);
    });
  }

  function getFilters() {
    return {
      category: els.categorySel.value,
      gender: els.genderSel.value,
      affiliation: els.affSel.value,
      year: Number(els.yearSlider.value),
    };
  }

  function mapAffiliationToUI(a) {
    if (a === "university") return "university";
    if (a === "research_institute") return "research_institute";
    return "organization";
  }

  function applyFilters(rows, f) {
    return rows.filter(r => {
      if (r.year !== f.year) return false;
      if (f.category !== "All" && r.category !== f.category) return false;
      if (f.gender !== "All" && r.gender !== f.gender) return false;
      if (f.affiliation !== "All" && r.aff_ui !== f.affiliation) return false;
      return true;
    });
  }

  function sumByCountry(rows) {
    const m = new Map();
    for (const r of rows) {
      const k = r.country || "unknown";
      m.set(k, (m.get(k) || 0) + r.count);
    }
    return [...m.entries()]
      .map(([country, count]) => ({ country, count }))
      .sort((a,b) => b.count - a.count || a.country.localeCompare(b.country));
  }

  function renderChart(data, f) {
    const y = data.map(d => d.country).reverse();
    const x = data.map(d => d.count).reverse();

    const titleBits = [
      `Nobel count by country — ${f.year}`,
      (f.category === "All" ? "All categories" : `Category: ${f.category}`),
      (f.gender === "All" ? "All genders" : `Gender: ${f.gender}`),
      (() => {
        if (f.affiliation === "All") return "All affiliations";
        if (f.affiliation === "university") return "University";
        if (f.affiliation === "research_institute") return "Research institute";
        return "Organization";
      })()
    ];

    const trace = {
      type: "bar",
      orientation: "h",
      y, x,
      hovertemplate: "<b>%{y}</b><br>Nobel prizes: %{x}<extra></extra>",
    };

    const layout = {
      title: { text: titleBits.join(" • "), x: 0.02, xanchor: "left", font: { size: 14 } },
      margin: { l: 170, r: 20, t: 70, b: 50 },
      xaxis: {
        title: "Number of Nobel prizes",
        rangemode: "tozero",
        tickmode: "linear",
        tick0: 0,
        dtick: 1,
        gridcolor: "#f0f0f0",
        zerolinecolor: "#e6e6e6"
      },
      yaxis: { title: "" },
      paper_bgcolor: "#ffffff",
      plot_bgcolor: "#ffffff",
      height: Math.max(520, 26 * y.length + 150),
    };

    Plotly.react("chart", [trace], layout, { displayModeBar: false, responsive: true });
  }

  function update() {
    const f = getFilters();
    els.yearVal.textContent = f.year;

    const filtered = applyFilters(DATA, f);
    const summed = sumByCountry(filtered);

    els.status.textContent =
      `Countries shown: ${summed.length.toLocaleString()} • Organization = company + government + other`;

    renderChart(summed, f);
  }

  async function loadMeta() {
    const res = await fetch(META_JSON_URL);
    if (!res.ok) throw new Error(`Cannot load ${META_JSON_URL} (${res.status})`);
    return await res.json();
  }

  async function loadAggCsv() {
    return new Promise((resolve, reject) => {
      Papa.parse(AGG_CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => resolve(results.data),
        error: (err) => reject(err),
      });
    });
  }

  async function init() {
    try {
      META = await loadMeta();

      // Category
      const catOpts = [{ value: "All", label: "All categories" }]
        .concat((META.categories ?? []).map(c => ({ value: c, label: c })));
      setOptions(els.categorySel, catOpts);

      // Gender
      const genOpts = [{ value: "All", label: "All" }]
        .concat((META.genders ?? []).map(g => ({ value: g, label: g })));
      setOptions(els.genderSel, genOpts);

      // Affiliation (3 gruppi)
      setOptions(els.affSel, AFF_UI);

      // Year slider
      const yMin = META.year_min ?? 1901;
      const yMax = META.year_max ?? 2025;
      els.yearSlider.min = String(yMin);
      els.yearSlider.max = String(yMax);
      els.yearSlider.step = "1";
      els.yearSlider.value = String(yMax);
      els.yearVal.textContent = String(yMax);

      // Data
      const raw = await loadAggCsv();
      DATA = raw.map(r => ({
        country: (r.country ?? "unknown").toString(),
        category: (r.category ?? "unknown").toString(),
        gender: (r.gender ?? "unknown").toString(),
        year: Number(r.year),
        aff_ui: mapAffiliationToUI(r.affiliation_type),
        count: Number(r.count) || 0,
      })).filter(r => Number.isFinite(r.year) && r.count > 0);

      // listeners
      [els.categorySel, els.genderSel, els.affSel].forEach(el => el.addEventListener("change", update));
      els.yearSlider.addEventListener("input", update);

      update();
    } catch (e) {
      console.error(e);
      els.status.textContent = `Error: ${e.message}`;
    }
  }

  init();
</script>
</body>
</html>

