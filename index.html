<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nobel distribution — Top countries</title>

  <!-- Plotly (grafico + tooltip) -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- PapaParse (CSV robusto) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#fff; --fg:#111; --muted:#666; --border:#e6e6e6; --card:#fafafa; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); }
    .wrap { max-width:1100px; margin:0 auto; padding:28px 16px 40px; }
    h1 { margin:0 0 6px 0; font-size:22px; font-weight:700; }
    .sub { margin:0 0 18px 0; color:var(--muted); font-size:13px; line-height:1.4; }
    .panel {
      display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px;
      padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--card);
      margin-bottom:14px;
    }
    .field label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    select, input[type="range"] { width:100%; }
    select { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:white; font-size:13px; }
    .rangeRow { display:flex; align-items:center; gap:10px; }
    .pill { font-size:12px; border:1px solid var(--border); background:white; padding:6px 10px; border-radius:999px; min-width:64px; text-align:center; }
    #chart { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    .foot { margin-top:10px; font-size:12px; color:var(--muted); }
    @media (max-width: 900px) { .panel { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px) { .panel { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Nobel distribution</h1>
    <p class="sub">
      Bar chart orizzontale — <b>Top N countries by Nobel count</b>.
      Filtri: category, year, gender (optional), affiliation type (optional). Tooltip: paese + count.
    </p>

    <div class="panel">
      <div class="field">
        <label for="categorySel">Category</label>
        <select id="categorySel"></select>
      </div>

      <div class="field">
        <label for="genderSel">Gender (optional)</label>
        <select id="genderSel"></select>
      </div>

      <div class="field">
        <label for="affSel">Affiliation type (optional)</label>
        <select id="affSel"></select>
      </div>

      <div class="field">
        <label for="topNSlider">Top N</label>
        <div class="rangeRow">
          <input id="topNSlider" type="range" min="5" max="30" step="1" value="15" />
          <span class="pill" id="topNVal">15</span>
        </div>
      </div>

      <div class="field" style="grid-column: 1 / -1;">
        <label for="yearSlider">Year</label>
        <div class="rangeRow">
          <input id="yearSlider" type="range" />
          <span class="pill" id="yearVal"></span>
        </div>
      </div>
    </div>

    <div id="chart"></div>
    <div class="foot" id="status">Loading…</div>
  </div>

<script>
  // =========================
  // CONFIG (tuoi file)
  // =========================
  const AGG_CSV_URL = "data/nobel_country_agg.csv";
  const META_JSON_URL = "data/nobel_filters_meta.json";

  // Dataset: colonne attese (dal tuo agg)
  // iso3, country, category, gender, year, affiliation_type, count

  let DATA = [];   // array di righe aggregate
  let META = null; // meta filtri

  const els = {
    categorySel: document.getElementById("categorySel"),
    genderSel: document.getElementById("genderSel"),
    affSel: document.getElementById("affSel"),
    yearSlider: document.getElementById("yearSlider"),
    yearVal: document.getElementById("yearVal"),
    topNSlider: document.getElementById("topNSlider"),
    topNVal: document.getElementById("topNVal"),
    status: document.getElementById("status"),
  };

  function setOptions(selectEl, values, includeAll = true) {
    selectEl.innerHTML = "";
    if (includeAll) {
      const opt = document.createElement("option");
      opt.value = "All";
      opt.textContent = "All";
      selectEl.appendChild(opt);
    }
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
  }

  function getFilters() {
    return {
      category: els.categorySel.value,
      gender: els.genderSel.value,
      affiliation_type: els.affSel.value,
      year: Number(els.yearSlider.value),
      topN: Number(els.topNSlider.value),
    };
  }

  function applyFilters(rows, f) {
    return rows.filter(r => {
      if (r.year !== f.year) return false;
      if (f.category !== "All" && r.category !== f.category) return false;
      if (f.gender !== "All" && r.gender !== f.gender) return false;
      if (f.affiliation_type !== "All" && r.affiliation_type !== f.affiliation_type) return false;
      return true;
    });
  }

  function sumByCountry(rows) {
    const m = new Map();
    for (const r of rows) {
      const k = r.country || "unknown";
      m.set(k, (m.get(k) || 0) + r.count);
    }
    return [...m.entries()]
      .map(([country, count]) => ({ country, count }))
      .sort((a,b) => b.count - a.count || a.country.localeCompare(b.country));
  }

  function renderChart(top, f) {
    const y = top.map(d => d.country).reverse();
    const x = top.map(d => d.count).reverse();

    const titleBits = [
      `Top ${f.topN} countries — Nobel count`,
      `Year: ${f.year}`,
    ];
    if (f.category !== "All") titleBits.push(`Category: ${f.category}`);
    if (f.gender !== "All") titleBits.push(`Gender: ${f.gender}`);
    if (f.affiliation_type !== "All") titleBits.push(`Affiliation: ${f.affiliation_type}`);

    const trace = {
      type: "bar",
      orientation: "h",
      y, x,
      hovertemplate: "<b>%{y}</b><br>Count: %{x}<extra></extra>",
    };

    const layout = {
      title: { text: titleBits.join(" • "), x: 0.02, xanchor: "left", font: { size: 14 } },
      margin: { l: 150, r: 20, t: 60, b: 40 },
      xaxis: { title: "Nobel count", rangemode: "tozero", gridcolor: "#f0f0f0", zerolinecolor: "#e6e6e6" },
      yaxis: { title: "" },
      paper_bgcolor: "#ffffff",
      plot_bgcolor: "#ffffff",
      height: Math.max(520, 26 * y.length + 140),
    };

    Plotly.react("chart", [trace], layout, { displayModeBar: false, responsive: true });
  }

  function update() {
    const f = getFilters();
    els.yearVal.textContent = f.year;
    els.topNVal.textContent = f.topN;

    const filtered = applyFilters(DATA, f);
    const summed = sumByCountry(filtered);
    const top = summed.slice(0, f.topN);

    els.status.textContent =
      `Rows matched: ${filtered.length.toLocaleString()} • Countries shown: ${top.length.toLocaleString()}`;

    renderChart(top, f);
  }

  async function loadMeta() {
    const res = await fetch(META_JSON_URL);
    if (!res.ok) throw new Error(`Cannot load ${META_JSON_URL} (${res.status})`);
    return await res.json();
  }

  async function loadAggCsv() {
    return new Promise((resolve, reject) => {
      Papa.parse(AGG_CSV_URL, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => resolve(results.data),
        error: (err) => reject(err),
      });
    });
  }

  async function init() {
    try {
      // 1) meta filtri (categorie, gender, affiliation_types, year_min/max)
      META = await loadMeta();

      setOptions(els.categorySel, META.categories ?? [], true);
      setOptions(els.genderSel, META.genders ?? [], true);
      setOptions(els.affSel, META.affiliation_types ?? [], true);

      // slider anni
      const yMin = META.year_min ?? 1901;
      const yMax = META.year_max ?? 2025;
      els.yearSlider.min = String(yMin);
      els.yearSlider.max = String(yMax);
      els.yearSlider.step = "1";
      els.yearSlider.value = String(yMax);
      els.yearVal.textContent = String(yMax);

      // 2) dati aggregati
      const raw = await loadAggCsv();

      // normalizza tipi
      DATA = raw.map(r => ({
        iso3: (r.iso3 ?? "").toString(),
        country: (r.country ?? "unknown").toString(),
        category: (r.category ?? "unknown").toString(),
        gender: (r.gender ?? "unknown").toString(),
        year: Number(r.year),
        affiliation_type: (r.affiliation_type ?? "unknown").toString(),
        count: Number(r.count) || 0,
      })).filter(r => Number.isFinite(r.year) && r.count > 0);

      // listeners
      [els.categorySel, els.genderSel, els.affSel].forEach(el => el.addEventListener("change", update));
      [els.yearSlider, els.topNSlider].forEach(el => el.addEventListener("input", update));

      update();
    } catch (e) {
      console.error(e);
      els.status.textContent = `Error: ${e.message}`;
    }
  }

  init();
</script>
</body>
</html>
